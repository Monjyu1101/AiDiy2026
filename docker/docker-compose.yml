services:
  aidiy2026:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: aidiy2026
    # External ports exposed for direct access
    ports:
      - "8090:8090"  # Frontend
      - "8091:8091"  # Backend Core API
      - "8092:8092"  # Backend Apps API
    volumes:
      # Mount temp directory for persistent data
      - ../temp:/app/temp
      # Mount database directory (backend_server配下に配置)
      - ../_data:/app/backend_server/_data
      # Mount backend icons (if needed)
      - ../backend_server/_icons:/app/backend_server/_icons
      # Mount config directory for API keys
      - ../backend_server/_config:/app/backend_server/_config:ro
      # Share frontend dist with nginx
      - frontend-dist:/app/frontend_server/dist
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=utf-8
      - SERVER_HOST=0.0.0.0
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # HTTPS Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: aidiy2026-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - frontend-dist:/usr/share/nginx/html:ro
    depends_on:
      - aidiy2026
    restart: unless-stopped

volumes:
  aidiy-data:
    driver: local
  frontend-dist:
    driver: local