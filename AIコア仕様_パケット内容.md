# AIコア仕様_パケット内容

本書は `WebSocket /core/ws/AIコア` の実装に基づく、チャンネル別パケット仕様です。
（作成時点の実装準拠。将来変更時は更新してください）

## 1. チャンネル定義

- `-2`: 音声専用入力/制御
- `-1`: 共通入力（テキスト/画像/操作）
- `0`: チャット出力
- `1`: コードエージェント1出力
- `2`: コードエージェント2出力
- `3`: コードエージェント3出力
- `4`: コードエージェント4出力

## 2. 接続シーケンス

1. クライアントが WebSocket 接続
2. クライアント最初の送信:
   - `type: "connect"`
   - `セッションID`（任意。再接続時）
   - `ソケット番号`（必須運用: `-2/-1/0..4`）
3. サーバー応答:
   - `メッセージ識別: "init"`
   - `チャンネル: ソケット番号`
   - `-1` のみ `メッセージ内容` に `ボタン`, `モデル設定` を含む

## 3. 共通パケット形式

主要キー（必要に応じて使用）:

- `セッションID: string`
- `チャンネル: int`
- `メッセージ識別: string`
- `メッセージ内容: any`
- `ファイル名: string | null`
- `サムネイル画像: string | null`
- `出力先チャンネル: int`（入力系で振り分けに使用）

## 4. チャンネル別パケット（送受信）

### 4.1 チャンネル `-2`（音声専用）

- 送信（クライアント -> サーバー）
  - `input_audio`
    - `メッセージ内容`: `audio/pcm`
    - `ファイル名`: Base64 PCM
  - `cancel_audio`
    - 音声再生停止要求
- 受信（サーバー -> クライアント）
  - `output_audio`
    - `メッセージ内容`: MIME（通常 `audio/pcm`）
    - `ファイル名`: Base64音声
  - `cancel_audio`
    - ユーザー音声検出時などの停止通知

### 4.2 チャンネル `-1`（共通入力）

- 送信（クライアント -> サーバー）
  - `operations`
    - `メッセージ内容.ボタン` を更新保存
  - `input_text`
    - `出力先チャンネル`: `0..4`
    - `ファイル名`: モード文字列（例: `chat` / `live` / `code`）
  - `input_request`
    - コード系要求（通常 `出力先チャンネル: 1..4`）
  - `input_file`
    - `メッセージ内容`: Base64ファイル本体
    - `ファイル名`: 元ファイル名
    - `出力先チャンネル`: `0..4`
  - `input_image`
    - `メッセージ内容`: MIME（例 `image/png`）
    - `ファイル名`: Base64画像本体
- 受信（サーバー -> クライアント）
  - `init`（`-1`のみ `ボタン` / `モデル設定` を含む）
  - `streaming_started`
  - `heartbeat`
  - `error`

### 4.3 チャンネル `0`（チャット出力）

- 送信（クライアント -> サーバー）
  - 通常なし（入力は `-1` 経由）
- 受信（サーバー -> クライアント）
  - `welcome_info`
  - `welcome_text`
  - `input_text`（エコーバック）
  - `input_file`（エコーバック）
  - `output_text`
  - `output_file`
  - `recognition_input`
  - `recognition_output`

### 4.4 チャンネル `1..4`（コードエージェント出力）

- 送信（クライアント -> サーバー）
  - 通常なし（入力は `-1` 経由）
- 受信（サーバー -> クライアント）
  - `welcome_info`
  - `welcome_text`
  - `input_text`（エコーバック）
  - `input_request`（エコーバック）
  - `input_file`（エコーバック）
  - `output_text`
  - `output_file`
  - `output_request`
  - `output_stream`

## 5. 負荷最適化上の運用ルール

- `-2` は音声専用として運用する。
- `-2` では `input_audio` / `cancel_audio` 以外を送らない。
- `-1` は音声以外（操作・テキスト・画像）に限定する。
- 不明な `メッセージ識別` はサーバーでエラー扱い（ログ出力）。

## 6. 代表サンプル

### 6.1 音声入力（クライアント -> サーバー）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": -2,
  "メッセージ識別": "input_audio",
  "メッセージ内容": "audio/pcm",
  "ファイル名": "<base64_pcm>",
  "サムネイル画像": null
}
```

### 6.2 テキスト入力（クライアント -> サーバー）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": -1,
  "出力先チャンネル": 0,
  "メッセージ識別": "input_text",
  "メッセージ内容": "こんにちは",
  "ファイル名": "chat",
  "サムネイル画像": null
}
```

### 6.3 音声出力（サーバー -> クライアント）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": -2,
  "メッセージ識別": "output_audio",
  "メッセージ内容": "audio/pcm",
  "ファイル名": "<base64_pcm>",
  "サムネイル画像": null
}
```
