# AIコア仕様_パケット内容

本書は `WebSocket /core/ws/AIコア` の実装に基づく、チャンネル別パケット仕様です。
（作成時点の実装準拠。将来変更時は更新してください）

## 1. チャンネル定義

- `"audio"`: 音声専用入力/制御
- `"input"`: 共通入力（テキスト/画像/操作/ファイル要求）
- `"file"`: ファイル一覧の応答専用（サーバー→クライアント）
- `"0"`: チャット出力
- `"1"`.`"4"`: コードエージェント出力

## 2. 接続シーケンス

1. クライアントが WebSocket 接続
2. クライアント最初の送信:
   - `type: "connect"`
   - `セッションID`（任意。再接続時）
   - `ソケット番号`（必須運用: `"audio"/"input"/"file"/"0".."4"`）
3. サーバー応答:
   - `メッセージ識別: "init"`
   - `チャンネル: ソケット番号`
   - `"input"` のみ `メッセージ内容` に `ボタン`, `モデル設定` を含む

## 3. 共通パケット形式

主要キー（必要に応じて使用）:

- `セッションID: string`
- `チャンネル: string`
- `メッセージ識別: string`
- `メッセージ内容: any`
- `ファイル名: string | null`
- `サムネイル画像: string | null`
- `出力先チャンネル: string`（入力系で振り分けに使用）

## 4. チャンネル別パケット（送受信）

### 4.1 チャンネル `"audio"`（音声専用）

- 送信（クライアント → サーバー）
  - `input_audio`
    - `メッセージ内容`: `audio/pcm`
    - `ファイル名`: Base64 PCM
  - `cancel_audio`
    - 音声再生停止要求
- 受信（サーバー → クライアント）
  - `output_audio`
    - `メッセージ内容`: MIME（通常 `audio/pcm`）
    - `ファイル名`: Base64音声
  - `cancel_audio`
    - ユーザー音声検出時などの停止通知

### 4.2 チャンネル `"input"`（共通入力）

- 送信（クライアント → サーバー）
  - `operations`
    - `メッセージ内容.ボタン` を更新保存
  - `input_text`
    - `出力先チャンネル`: `"0".."4"`
    - `ファイル名`: モード文字列（例: `chat` / `live` / `code`）
    - `メッセージ内容`: テキスト本文
  - `input_request`
    - コード系要求（通常 `出力先チャンネル: "1".."4"`）
  - `input_file`
    - `メッセージ内容`: Base64ファイル本体
    - `ファイル名`: 元ファイル名
    - `出力先チャンネル`: `"0".."4"`
  - `input_image`
    - `メッセージ内容`: MIME（例 `image/jpeg`）
    - `ファイル名`: Base64画像本体
    - `出力先チャンネル`: `"0"`（LiveAIへルーティング）
  - `cancel_run`
    - `チャンネル`: 停止対象チャンネル（`"1".."4"`）
  - `files_backup`
    - `チャンネル`: `"file"`（応答の送信先）
    - `メッセージ内容`: `""`（空文字列）
  - `files_temp`
    - `チャンネル`: `"file"`（応答の送信先）
    - `メッセージ内容`: `""`（空文字列）
- 受信（サーバー → クライアント）
  - `init`（`"input"` のみ `ボタン` / `モデル設定` を含む）
  - `streaming_started`
  - `heartbeat`
  - `error`
    - `メッセージ内容`: エラー文字列

### 4.3 チャンネル `"file"`（ファイル一覧応答）

- 送信（クライアント → サーバー）
  - なし（リクエストは `"input"` チャンネル経由で送信）
- 受信（サーバー → クライアント）
  - `files_backup`
    - `メッセージ内容`:
      - `プロジェクトパス: string` — ソースファイルの絶対パス
      - `バックアップベースパス: string` — バックアップ先の絶対パス
      - `最終ファイル日時: string | null` — バックアップの最終更新日時
      - `ファイルリスト: [{パス: string, 更新日時: string}, ...]`
  - `files_temp`
    - `メッセージ内容`:
      - `作業ファイル日時: string` — temp内の最新ファイルmtime（変化なければ同値）
      - `ファイルリスト: [{パス: string, 更新日時: string}, ...]`

### 4.4 チャンネル `"0"`（チャット出力）

- 送信（クライアント → サーバー）
  - 通常なし（入力は `"input"` 経由）
- 受信（サーバー → クライアント）
  - `welcome_info`
  - `welcome_text`
  - `input_text`（エコーバック）
  - `input_file`（エコーバック）
  - `output_text`
  - `output_file`
  - `recognition_input`
  - `recognition_output`

### 4.5 チャンネル `"1".."4"`（コードエージェント出力）

- 送信（クライアント → サーバー）
  - 通常なし（入力は `"input"` 経由）
- 受信（サーバー → クライアント）
  - `welcome_info`
  - `welcome_text`
  - `input_text`（エコーバック）
  - `input_request`（エコーバック）
  - `input_file`（エコーバック）
  - `output_text`
  - `output_file`
  - `output_stream`
  - `cancel_run`（中断完了通知）
    - `メッセージ内容`: `"処理中断！"`

補足（`frontend_server/src/components/AIコア/compornents/AIコード.vue` の表示実装）:

- 画面表示対象: `input_text`, `input_request`, `input_file`, `output_text`, `output_file`, `welcome_text`
- `output_stream` はストリーム表示として受信し、画面上は `output_text` 系表示で扱う
- `output_request` は現行実装ではハンドラ未登録のため表示しない

## 5. 負荷最適化上の運用ルール

- `"audio"` は音声専用として運用する。
- `"audio"` では `input_audio` / `cancel_audio` 以外を送らない。
- `"input"` は音声以外（操作・テキスト・画像・ファイル要求・停止）に限定する。
- `"file"` はサーバーからの応答専用。クライアントからの要求は `"input"` チャンネルで送信し、`チャンネル: "file"` を指定する。
- 不明な `メッセージ識別` はサーバーでエラー扱い（ログ出力）。

## 6. ファイル一覧のスキップ最適化

フロントエンドは `files_backup` / `files_temp` の応答を受信時、以下が前回表示と同一なら画面更新をスキップする:

- `files_backup`: `最終ファイル日時` + `ファイルリスト.length`
- `files_temp`: `作業ファイル日時` + `ファイルリスト.length`

## 7. 代表サンプル

### 7.1 音声入力（クライアント → サーバー）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": "audio",
  "メッセージ識別": "input_audio",
  "メッセージ内容": "audio/pcm",
  "ファイル名": "<base64_pcm>",
  "サムネイル画像": null
}
```

### 7.2 テキスト入力（クライアント → サーバー）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": "input",
  "出力先チャンネル": "0",
  "メッセージ識別": "input_text",
  "メッセージ内容": "こんにちは",
  "ファイル名": "chat",
  "サムネイル画像": null
}
```

### 7.3 音声出力（サーバー → クライアント）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": "audio",
  "メッセージ識別": "output_audio",
  "メッセージ内容": "audio/pcm",
  "ファイル名": "<base64_pcm>",
  "サムネイル画像": null
}
```

### 7.4 ファイル一覧要求（クライアント → サーバー）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": "file",
  "メッセージ識別": "files_backup",
  "メッセージ内容": ""
}
```

### 7.5 ファイル一覧応答 - backup（サーバー → クライアント）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": "file",
  "メッセージ識別": "files_backup",
  "メッセージ内容": {
    "プロジェクトパス": "D:\\project",
    "バックアップベースパス": "D:\\backup",
    "最終ファイル日時": "2026/02/26 20:00:00",
    "ファイルリスト": [
      {"パス": "src/main.py", "更新日時": "2026/02/26 19:30:00"},
      {"パス": "src/utils.py", "更新日時": "2026/02/25 10:00:00"}
    ]
  }
}
```

### 7.6 ファイル一覧応答 - temp（サーバー → クライアント）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": "file",
  "メッセージ識別": "files_temp",
  "メッセージ内容": {
    "作業ファイル日時": "2026/02/26 20:44:53",
    "ファイルリスト": [
      {"パス": "temp/input/20260226.204453.image.png", "更新日時": "2026/02/26 20:44:53"},
      {"パス": "temp/output/result.txt", "更新日時": "2026/02/26 20:40:00"}
    ]
  }
}
```

### 7.7 画像入力（クライアント → サーバー）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": "input",
  "出力先チャンネル": "0",
  "メッセージ識別": "input_image",
  "メッセージ内容": "image/jpeg",
  "ファイル名": "<base64_image>",
  "サムネイル画像": null
}
```

### 7.8 コード実行停止（クライアント → サーバー）

```json
{
  "セッションID": "ws-xxxx",
  "チャンネル": "1",
  "メッセージ識別": "cancel_run",
  "メッセージ内容": ""
}
```
