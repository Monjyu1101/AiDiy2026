<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>03 _start.py 解説</title>
  <link rel="stylesheet" href="../_shared/doc.css">
  <script src="../_shared/doc.js" defer></script>
</head>
<body>
  <nav>
    <a href="02_setup.py解説.html">前へ: 02_setup.py解説</a>
    <a href="_index.html">目次へ戻る</a>
    <a href="04_設定ファイル.html">次へ: 04_設定ファイル</a>
  </nav>

  <h1>03_start.py解説</h1>
  <p>対象ファイルは <code>workspace/AiDiy2026/_start.py</code> です。このスクリプトは「起動」だけでなく、環境確認、ポート解放、監視、再起動、停止まで担当します。</p>

  <h2>コード全体（参照）</h2>
  <pre data-src="code_samples/_start.py"><code>読み込み中...</code></pre>

  <h2>起動対象とポート</h2>
  <table>
    <tr><th>対象</th><th>ポート</th><th>URL</th></tr>
    <tr><td>バックエンド core_main</td><td>8091</td><td><code>http://localhost:8091</code></td></tr>
    <tr><td>バックエンド apps_main</td><td>8092</td><td><code>http://localhost:8092</code></td></tr>
    <tr><td>フロントエンド Vite</td><td>8090</td><td><code>http://localhost:8090</code></td></tr>
  </table>

  <h2>起動前チェック</h2>
  <ul>
    <li>バックエンド: venv と <code>pyproject.toml</code> の存在確認</li>
    <li>フロントエンド: npm コマンドと <code>node_modules</code> の存在確認</li>
    <li>不足時は理由と解決コマンドを表示して中止</li>
  </ul>

  <h2>自動起動の流れ</h2>
  <pre><code>1. 既存ポートの解放
   - 8090 / 8091 / 8092 の LISTEN プロセスを停止

2. バックエンド起動
   - core_main:app (8091)
   - apps_main:app (8092)

3. フロントエンド起動
   - npm run dev -- --port 8090

4. 出力ストリームを監視
   - サービスごとにログをプレフィックス付きで表示

5. ブラウザを自動起動
   - http://localhost:8090

6. 異常終了を検知したら15秒後に再起動</code></pre>

  <h2>ポート解放ロジックの要点</h2>
  <table>
    <tr><th>OS</th><th>確認方法</th><th>停止方法</th></tr>
    <tr><td>Windows</td><td><code>netstat -ano -p tcp</code></td><td><code>taskkill /F /T /PID ...</code></td></tr>
    <tr><td>Linux/macOS</td><td><code>lsof</code> または <code>ss</code></td><td><code>kill -9 ...</code></td></tr>
  </table>

  <h2>停止とリブート</h2>
  <ul>
    <li><code>Ctrl+C</code> で全プロセス停止処理に入る</li>
    <li>Windows では停止後10秒以内に <code>R</code> 押下でリブート可能</li>
    <li>通常終了時は停止完了メッセージを出して終了</li>
  </ul>

  <h2>手動起動ガイダンスが表示される理由</h2>
  <p><code>_start.py</code> は、起動前に手動コマンドも表示します。これは障害調査時に、スクリプト経由と手動起動を切り分けるためです。</p>

  <h2>実行例</h2>
  <pre><code>cd workspace/AiDiy2026
python _start.py

# バックエンドのみ起動
python _start.py --backend=yes --frontend=no

# フロントエンドのみ起動
python _start.py --backend=no --frontend=yes</code></pre>

  <h2>トラブル切り分けの順序</h2>
  <ol>
    <li>ポート競合がないか確認する</li>
    <li>依存関係不足がないか確認する（<code>uv sync</code>, <code>npm install</code>）</li>
    <li>core / apps / frontend のどれが落ちたかログプレフィックスで確認する</li>
    <li>必要なら手動起動コマンドで単体検証する</li>
  </ol>

  <nav>
    <a href="02_setup.py解説.html">前へ: 02_setup.py解説</a>
    <a href="_index.html">目次へ戻る</a>
    <a href="04_設定ファイル.html">次へ: 04_設定ファイル</a>
  </nav>
</body>
</html>

