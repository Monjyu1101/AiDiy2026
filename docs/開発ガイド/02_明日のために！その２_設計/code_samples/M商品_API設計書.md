# M商品 API設計書

**作成日**: 2026-02-15
**対象API**: M商品関連API
**バージョン**: 1.0
**ベースURL**: `http://localhost:8092`

---

## 1. API一覧

| エンドポイント | メソッド | 概要 | 認証 |
|---------------|----------|------|------|
| `/apps/V商品/一覧` | POST | 商品一覧を取得（生SQL） | 必須 |
| `/apps/M商品/取得` | POST | 指定した商品の詳細を取得 | 必須 |
| `/apps/M商品/登録` | POST | 新規商品を登録 | 必須 |
| `/apps/M商品/変更` | POST | 既存商品を更新 | 必須 |
| `/apps/M商品/削除` | POST | 商品を削除 | 必須 |

---

## 2. 共通仕様

### 2.1 認証方式

**JWT（JSON Web Token）認証**

- ログイン時に発行されたトークンをリクエストヘッダーに付与
- トークンの有効期限: 8時間

#### リクエストヘッダー

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

#### 認証エラーレスポンス

**HTTPステータス**: 401

```json
{
 "status": "NG",
 "message": "認証に失敗しました",
 "error": {
 "code": "UNAUTHORIZED"
 }
}
```

### 2.2 統一レスポンス形式

すべてのAPIで以下の形式を使用します。

#### 成功レスポンス

```json
{
 "status": "OK",
 "message": "メッセージ文字列",
 "data": { ... }
}
```

#### エラーレスポンス

```json
{
 "status": "NG",
 "message": "エラーメッセージ",
 "error": {
 "code": "ERROR_CODE",
 "field": "項目名" // 任意
 }
}
```

### 2.3 HTTPステータスコード

| ステータス | 用途 |
|-----------|------|
| 200 | 成功（業務エラーも200で返却し、`status: NG`で判定） |
| 401 | 認証エラー |
| 500 | サーバーエラー |

### 2.4 エラーコード一覧

| コード | 意味 | HTTPステータス |
|--------|------|----------------|
| `VALIDATION_ERROR` | バリデーションエラー | 200 |
| `DUPLICATE_ERROR` | データ重複エラー | 200 |
| `NOT_FOUND` | データ未検出 | 200 |
| `UNAUTHORIZED` | 認証エラー | 401 |
| `SERVER_ERROR` | サーバーエラー | 500 |

---

## 3. API詳細仕様

### 3.1 商品一覧取得

**エンドポイント**: `POST /apps/V商品/一覧`

**概要**: 商品一覧を取得する（生SQLで高速化）

#### リクエスト

**ヘッダー**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**ボディ**

```json
{}
```

*リクエストボディは空でOK*

#### レスポンス

**成功時（200）**

```json
{
 "status": "OK",
 "message": "商品一覧を取得しました",
 "data": {
 "items": [
 {
 "商品ID": "ITEM001",
 "商品名": "テスト商品A",
 "単位": "個",
 "商品備考": "サンプルデータです",
 "更新日時": "2026-02-15 10:30:00",
 "更新利用者名": "admin"
 },
 {
 "商品ID": "ITEM002",
 "商品名": "テスト商品B",
 "単位": "箱",
 "商品備考": "10個入り",
 "更新日時": "2026-02-15 11:00:00",
 "更新利用者名": "user01"
 }
 ],
 "total": 2,
 "limit": 10000
 }
}
```

**エラー時（200）**

```json
{
 "status": "NG",
 "message": "データの取得に失敗しました",
 "error": {
 "code": "SERVER_ERROR"
 }
}
```

#### データ項目

| 項目名 | 型 | 説明 |
|--------|-----|------|
| items | Array | 商品一覧 |
| items[].商品ID | String | 商品ID |
| items[].商品名 | String | 商品名 |
| items[].単位 | String | 単位 |
| items[].商品備考 | String | 商品備考 |
| items[].更新日時 | String | 最終更新日時（YYYY-MM-DD HH:MM:SS） |
| items[].更新利用者名 | String | 最終更新者名 |
| total | Integer | 取得件数 |
| limit | Integer | 最大取得件数（10000固定） |

---

### 3.2 商品詳細取得

**エンドポイント**: `POST /apps/M商品/取得`

**概要**: 指定した商品の詳細情報を取得する

#### リクエスト

**ヘッダー**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**ボディ**

```json
{
 "商品ID": "ITEM001"
}
```

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| 商品ID | String | ○ | 取得する商品のID |

#### レスポンス

**成功時（200）**

```json
{
 "status": "OK",
 "message": "商品情報を取得しました",
 "data": {
 "商品ID": "ITEM001",
 "商品名": "テスト商品A",
 "単位": "個",
 "商品備考": "サンプルデータです",
 "登録日時": "2026-02-10 09:00:00",
 "登録利用者ID": "admin",
 "登録利用者名": "管理者",
 "登録端末ID": "192.168.1.100",
 "更新日時": "2026-02-15 10:30:00",
 "更新利用者ID": "admin",
 "更新利用者名": "管理者",
 "更新端末ID": "192.168.1.100"
 }
}
```

**エラー時（200）**

```json
{
 "status": "NG",
 "message": "指定された商品が見つかりません",
 "error": {
 "code": "NOT_FOUND"
 }
}
```

#### データ項目

| 項目名 | 型 | 説明 |
|--------|-----|------|
| 商品ID | String | 商品ID |
| 商品名 | String | 商品名 |
| 単位 | String | 単位 |
| 商品備考 | String | 商品備考 |
| 登録日時 | String | 登録日時（YYYY-MM-DD HH:MM:SS） |
| 登録利用者ID | String | 登録利用者ID |
| 登録利用者名 | String | 登録利用者名 |
| 登録端末ID | String | 登録端末ID |
| 更新日時 | String | 更新日時（YYYY-MM-DD HH:MM:SS） |
| 更新利用者ID | String | 更新利用者ID |
| 更新利用者名 | String | 更新利用者名 |
| 更新端末ID | String | 更新端末ID |

---

### 3.3 商品登録

**エンドポイント**: `POST /apps/M商品/登録`

**概要**: 新規商品を登録する

#### リクエスト

**ヘッダー**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**ボディ**

```json
{
 "商品ID": "ITEM004",
 "商品名": "新しい商品",
 "単位": "個",
 "商品備考": "これは新規商品です"
}
```

| 項目名 | 型 | 必須 | 最大長 | 説明 |
|--------|-----|------|--------|------|
| 商品ID | String | ○ | 50 | 商品ID（手動入力） |
| 商品名 | String | ○ | 200 | 商品名 |
| 単位 | String | ○ | 50 | 単位 |
| 商品備考 | String | - | 500 | 商品備考 |

*監査フィールドはバックエンドで自動設定されるため、送信不要*

#### レスポンス

**成功時（200）**

```json
{
 "status": "OK",
 "message": "登録しました",
 "data": {
 "商品ID": "ITEM004",
 "商品名": "新しい商品",
 "単位": "個",
 "商品備考": "これは新規商品です",
 "登録日時": "2026-02-15 14:00:00",
 "登録利用者ID": "admin",
 "登録利用者名": "管理者",
 "登録端末ID": "192.168.1.100",
 "更新日時": "2026-02-15 14:00:00",
 "更新利用者ID": "admin",
 "更新利用者名": "管理者",
 "更新端末ID": "192.168.1.100"
 }
}
```

**バリデーションエラー（200）**

```json
{
 "status": "NG",
 "message": "商品名を入力してください",
 "error": {
 "code": "VALIDATION_ERROR",
 "field": "商品名"
 }
}
```

**重複エラー（200）**

```json
{
 "status": "NG",
 "message": "この商品IDは既に登録されています",
 "error": {
 "code": "DUPLICATE_ERROR",
 "field": "商品ID"
 }
}
```

#### バリデーションルール

| 項目 | ルール | エラーメッセージ |
|------|--------|------------------|
| 商品ID | 必須 | 「商品IDを入力してください」 |
| 商品ID | 最大50文字 | 「商品IDは50文字以内で入力してください」 |
| 商品ID | 重複チェック | 「この商品IDは既に登録されています」 |
| 商品名 | 必須 | 「商品名を入力してください」 |
| 商品名 | 最大200文字 | 「商品名は200文字以内で入力してください」 |
| 単位 | 必須 | 「単位を入力してください」 |
| 単位 | 最大50文字 | 「単位は50文字以内で入力してください」 |
| 商品備考 | 最大500文字 | 「商品備考は500文字以内で入力してください」 |

---

### 3.4 商品変更

**エンドポイント**: `POST /apps/M商品/変更`

**概要**: 既存商品を更新する

#### リクエスト

**ヘッダー**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**ボディ**

```json
{
 "商品ID": "ITEM001",
 "商品名": "更新後の商品名",
 "単位": "箱",
 "商品備考": "更新しました"
}
```

| 項目名 | 型 | 必須 | 最大長 | 説明 |
|--------|-----|------|--------|------|
| 商品ID | String | ○ | - | 更新対象の商品ID（変更不可） |
| 商品名 | String | ○ | 200 | 商品名 |
| 単位 | String | ○ | 50 | 単位 |
| 商品備考 | String | - | 500 | 商品備考 |

*監査フィールド（更新系）はバックエンドで自動設定されるため、送信不要*

#### レスポンス

**成功時（200）**

```json
{
 "status": "OK",
 "message": "変更しました",
 "data": {
 "商品ID": "ITEM001",
 "商品名": "更新後の商品名",
 "単位": "箱",
 "商品備考": "更新しました",
 "登録日時": "2026-02-10 09:00:00",
 "登録利用者ID": "admin",
 "登録利用者名": "管理者",
 "登録端末ID": "192.168.1.100",
 "更新日時": "2026-02-15 15:00:00",
 "更新利用者ID": "user01",
 "更新利用者名": "ユーザー01",
 "更新端末ID": "192.168.1.200"
 }
}
```

**データ未検出エラー（200）**

```json
{
 "status": "NG",
 "message": "指定された商品が見つかりません",
 "error": {
 "code": "NOT_FOUND"
 }
}
```

**バリデーションエラー（200）**

```json
{
 "status": "NG",
 "message": "商品名を入力してください",
 "error": {
 "code": "VALIDATION_ERROR",
 "field": "商品名"
 }
}
```

#### バリデーションルール

| 項目 | ルール | エラーメッセージ |
|------|--------|------------------|
| 商品ID | 必須 | 「商品IDを入力してください」 |
| 商品ID | 存在チェック | 「指定された商品が見つかりません」 |
| 商品名 | 必須 | 「商品名を入力してください」 |
| 商品名 | 最大200文字 | 「商品名は200文字以内で入力してください」 |
| 単位 | 必須 | 「単位を入力してください」 |
| 単位 | 最大50文字 | 「単位は50文字以内で入力してください」 |
| 商品備考 | 最大500文字 | 「商品備考は500文字以内で入力してください」 |

---

### 3.5 商品削除

**エンドポイント**: `POST /apps/M商品/削除`

**概要**: 商品を削除する（物理削除）

#### リクエスト

**ヘッダー**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**ボディ**

```json
{
 "商品ID": "ITEM001"
}
```

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| 商品ID | String | ○ | 削除する商品のID |

#### レスポンス

**成功時（200）**

```json
{
 "status": "OK",
 "message": "削除しました"
}
```

**データ未検出エラー（200）**

```json
{
 "status": "NG",
 "message": "指定された商品が見つかりません",
 "error": {
 "code": "NOT_FOUND"
 }
}
```

**外部キー制約エラー（200）**

```json
{
 "status": "NG",
 "message": "この商品は使用中のため削除できません",
 "error": {
 "code": "FOREIGN_KEY_ERROR"
 }
}
```

#### バリデーションルール

| 項目 | ルール | エラーメッセージ |
|------|--------|------------------|
| 商品ID | 必須 | 「商品IDを入力してください」 |
| 商品ID | 存在チェック | 「指定された商品が見つかりません」 |
| 商品ID | 外部キーチェック | 「この商品は使用中のため削除できません」 |

---

## 4. 業務ロジック

### 4.1 監査フィールドの自動設定

**登録時**

| フィールド | 設定値 |
|-----------|--------|
| 登録日時 | 現在日時（YYYY-MM-DD HH:MM:SS） |
| 登録利用者ID | JWT認証から取得した利用者ID |
| 登録利用者名 | JWT認証から取得した利用者名 |
| 登録端末ID | リクエスト元IPアドレス |
| 更新日時 | 現在日時（YYYY-MM-DD HH:MM:SS） |
| 更新利用者ID | JWT認証から取得した利用者ID |
| 更新利用者名 | JWT認証から取得した利用者名 |
| 更新端末ID | リクエスト元IPアドレス |

**更新時**

| フィールド | 設定値 |
|-----------|--------|
| 登録系フィールド | 変更しない |
| 更新日時 | 現在日時（YYYY-MM-DD HH:MM:SS） |
| 更新利用者ID | JWT認証から取得した利用者ID |
| 更新利用者名 | JWT認証から取得した利用者名 |
| 更新端末ID | リクエスト元IPアドレス |

### 4.2 処理フロー

#### 登録処理

```
1. 認証チェック（JWT検証）
 ↓
2. リクエストボディのバリデーション
 ↓
3. 商品ID重複チェック
 ↓
4. 監査フィールドの自動設定
 ↓
5. データベースにINSERT
 ↓
6. 成功レスポンス返却
```

#### 変更処理

```
1. 認証チェック（JWT検証）
 ↓
2. リクエストボディのバリデーション
 ↓
3. 対象データの存在チェック
 ↓
4. 監査フィールド（更新系）の自動設定
 ↓
5. データベースをUPDATE
 ↓
6. 成功レスポンス返却
```

#### 削除処理

```
1. 認証チェック（JWT検証）
 ↓
2. 商品IDのバリデーション
 ↓
3. 対象データの存在チェック
 ↓
4. 外部キー制約チェック（必要な場合）
 ↓
5. データベースからDELETE
 ↓
6. 成功レスポンス返却
```

---

## 5. テスト仕様

### 5.1 Swagger UIでのテスト

**URL**: `http://localhost:8092/docs`

#### テスト手順

1. Swagger UIにアクセス
2. 右上の「Authorize」ボタンをクリック
3. JWTトークンを入力（事前にログインしてトークンを取得）
4. 各エンドポイントの「Try it out」ボタンをクリック
5. リクエストボディを入力
6. 「Execute」ボタンをクリック
7. レスポンスを確認

### 5.2 テストケース

#### 商品登録

| ケース | リクエスト | 期待結果 |
|--------|-----------|----------|
| 正常系 | すべての項目が正しい | status: OK |
| 商品ID未入力 | 商品ID="" | status: NG, message: "商品IDを入力してください" |
| 商品名未入力 | 商品名="" | status: NG, message: "商品名を入力してください" |
| 商品ID重複 | 既存の商品ID | status: NG, message: "この商品IDは既に登録されています" |
| 商品名超過 | 商品名=201文字 | status: NG, message: "商品名は200文字以内で入力してください" |

---

## 変更履歴

| 日付 | バージョン | 変更者 | 変更内容 |
|------|------------|--------|----------|
| 2026-02-15 | 1.0 | admin | 初版作成 |
